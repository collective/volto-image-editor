import { Meta } from '@storybook/blocks';

<Meta title="ImageEditor/Overview" />

# Image Editor - Overview

Complete image editing system for Plone/Volto, offering interactive cropping, transformations, and color adjustments with an intuitive and accessible interface.

---

## Objective

Provide a robust solution for image editing directly in the browser, without the need for external tools, while maintaining quality and performance.

---

## Architecture

### Component Structure

```
ImageEditorWrapper (Modal)
  └─ ImageEditor (Main Editor)
      ├─ Cropper (react-advanced-cropper)
      │   ├─ AdjustableCropperBackground
      │   └─ Stencil (Rectangle or Circle)
      │
      ├─ CropperPreview
      │   └─ AdjustablePreviewBackground
      │
      ├─ Navigation (Toolbar)
      │   ├─ Button (Crop)
      │   ├─ Button (Rotate Left)
      │   ├─ Button (Rotate Right)
      │   ├─ Button (Flip H/V)
      │   ├─ Button (Reset Rotation)
      │   ├─ Button (Saturation)
      │   ├─ Button (Brightness)
      │   ├─ Button (Contrast)
      │   ├─ Button (Hue)
      │   ├─ Button (Cancel)
      │   └─ Button (Save)
      │
      ├─ SettingsModal
      │   └─ Advanced settings
      │
      └─ Slider (when adjustment mode active)
```

---

## Main Components

### ImageEditorWrapper

**Purpose**: Wrapper that integrates the editor with Plone/Volto widgets

**Features:**

- Opens editor in modal (`@plone/components`)
- Converts data URLs to Plone format (base64)
- Manages widget value state
- Parses filename and content-type

**When to use:** In Plone/Volto image widgets

---

### ImageEditor

**Purpose**: Complete editor with all features

**Features:**

- Interactive crop with multiple aspect ratios
- Transformations (rotate, flip)
- Color adjustments (brightness, contrast, saturation, hue)
- Real-time preview
- Export to data URL

**When to use:** As standalone editor or within modals

---

### Navigation

**Purpose**: Toolbar with all controls

**Features:**

- Mode switching (crop, adjustments)
- Transformation buttons
- Rotation reset
- Save/cancel actions

**When to use:** Always together with ImageEditor

---

### SettingsModal

**Purpose**: Advanced settings panel

**Features:**

- Aspect ratio presets
- Image restrictions
- Stencil type (rectangle/circle)
- Min/max dimensions
- Grid toggle

**When to use:** When users need to customize crop behavior

---

### Primitives

#### Button

- Base button with active/disabled states
- Used throughout the interface

#### Slider

- Accessible slider control
- Keyboard, mouse and touch support
- Used for color adjustments

#### AdjustableImage

- Image renderer via Canvas
- Applies CSS-like filters via CanvasRenderingContext2D
- Hardware-accelerated when available

---

## Data Flow

### 1. Loading

```
URL/DataURL → ImageEditor → Cropper → Canvas
```

### 2. Editing

```
User interacts → Navigation changes mode →
  → Crop Mode: Stencil active
  → Adjustment Mode: Slider active → Updates adjustments →
    → AdjustableImage re-renders
```

### 3. Transformations

```
Rotate/Flip button → cropperRef.rotateImage() →
  → hasRotationChanges = true → Reset button visible
```

### 4. Saving

```
Save button → cropperRef.getCanvas() →
  → Apply adjustments → canvas.toDataURL() →
    → onImageSave(dataURL)
```

---

## Editor States

### Crop Mode

```tsx
{
  mode: 'crop',
  cropperEnabled: true,
  sliderVisible: false,
  stencil: { movable: true, resizable: true }
}
```

### Adjustment Mode (Brightness, Contrast, etc)

```tsx
{
  mode: 'brightness', // or contrast, saturation, hue
  cropperEnabled: false,
  sliderVisible: true,
  stencil: { movable: false, resizable: false, faded: true }
}
```

---

## State Management

### Local State (ImageEditor)

```tsx
const [mode, setMode] = useState('crop');
const [adjustments, setAdjustments] = useState({
  brightness: 0,
  contrast: 0,
  saturation: 0,
  hue: 0,
});
const [imageSettings, setImageSettings] = useState<ImageSettings>({...});
const [hasRotationChanges, setHasRotationChanges] = useState(false);
```

### Refs for Cropper

```tsx
const cropperRef = useRef<CropperRef>(null);
const previewRef = useRef<CropperPreviewRef>(null);
```

---

## Plone/Volto Integration

### Image Widget

```tsx
import ImageEditorWrapper from '@plone-collective/volto-image-editor/components/ImageEditor/ImageEditorWrapper';

function ImageWidget({ value, onChange }) {
  return (
    <div>
      {value?.download && <img src={value.download} alt={value.filename} />}

      <ImageEditorWrapper
        value={value}
        setData={(newValue) => onChange('image', newValue)}
      />
    </div>
  );
}
```

### Plone Data Format

```tsx
// Input (value)
{
  download: 'http://plone.site/image.jpg', // Public URL
  filename: 'photo.jpg',
  'content-type': 'image/jpeg'
}

// Output (after editing)
{
  data: '/9j/4AAQSkZJRg...', // Base64 without prefix
  filename: 'photo.jpg',
  'content-type': 'image/jpeg',
  encoding: 'base64'
}
```

---

## Performance

### Implemented Optimizations

1. **Canvas Rendering**: Hardware-accelerated when available
2. **Lazy Loading**: Components loaded on demand
3. **Debounced Updates**: Preview updates efficiently
4. **Memoization**: Prevents unnecessary re-renders
5. **Single Draw Call**: All filters in one pass

### Benchmarks (Average)

| Image     | Crop | Adjust | Total |
| --------- | ---- | ------ | ----- |
| 640x480   | 5ms  | 2ms    | ~7ms  |
| 1920x1080 | 15ms | 8ms    | ~23ms |
| 4000x3000 | 60ms | 35ms   | ~95ms |

### Recommendations

- Images between 800x600 and 2000x1500 pixels
- Formats: JPEG (photos), PNG (transparency)
- Size: Up to 5MB for better UX
- Above 8MP: consider server-side resizing

---

## Accessibility

### Implementations

- Complete keyboard navigation
- Correct ARIA attributes
- Visible focus indicators
- Adequate contrast (WCAG AA)
- Descriptive labels
- Clear visual states

### Recommended Tests

```bash
# Axe DevTools
npx @axe-core/cli http://localhost:6006

# Pa11y
pa11y http://localhost:6006/iframe.html?id=imageeditor--landscape

# Lighthouse
lighthouse http://localhost:6006 --only-categories=accessibility
```

---

## Internationalization (i18n)

### Translatable Messages

All UI strings use `react-intl`:

```tsx
import { defineMessages, useIntl } from 'react-intl';

const messages = defineMessages({
  editorSettings: {
    id: 'Editor Settings',
    defaultMessage: 'Editor Settings',
  },
  // ... more messages
});

const intl = useIntl();
intl.formatMessage(messages.editorSettings);
```

### Supported Languages

- English (en)
- Português (pt-BR)
- Español (es)
- Deutsch (de)

### Adding a New Language

1. Generate the catalog:

```bash
pnpm i18n
```

2. Translate in `locales/{lang}/LC_MESSAGES/volto.po`

3. Compile:

```bash
pnpm i18n
```

---

## Security

### CORS

```tsx
// For external images
<AdjustableImage
  src="https://cdn.example.com/image.jpg"
  crossOrigin="anonymous"
/>
```

### CSP (Content Security Policy)

```
img-src 'self' data: https:;
script-src 'self' 'unsafe-inline';
style-src 'self' 'unsafe-inline';
```

### Input Validation

```tsx
// Validate size before loading
if (file.size > 10 * 1024 * 1024) {
  throw new Error('File too large (max 10MB)');
}

// Validate MIME type
const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
if (!allowedTypes.includes(file.type)) {
  throw new Error('Invalid file type');
}
```

---

## Testing

### Unit Tests

```tsx
import { render, fireEvent } from '@testing-library/react';
import { Button } from './Button';

test('button calls onClick when clicked', () => {
  const handleClick = jest.fn();
  const { getByText } = render(<Button onClick={handleClick}>Click me</Button>);

  fireEvent.click(getByText('Click me'));
  expect(handleClick).toHaveBeenCalledTimes(1);
});
```

### Integration Tests

```tsx
test('editor saves edited image', async () => {
  const handleSave = jest.fn();
  const { getByText } = render(
    <ImageEditor src={testImage} onImageSave={handleSave} />,
  );

  // Simulate editing
  fireEvent.click(getByText('Save'));

  await waitFor(() => {
    expect(handleSave).toHaveBeenCalled();
    expect(handleSave.mock.calls[0][0]).toMatch(/^data:image/);
  });
});
```

---

## Additional Resources

### Documentation

- [react-advanced-cropper](https://advanced-cropper.github.io/react-advanced-cropper/)
- [Canvas API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [@plone/components](https://plone.github.io/components/)

### Examples

- See the stories in this Storybook for practical use cases
- Source code in `/packages/volto-image-editor/src`

### Support

- Issues: [GitHub Issues](https://github.com/collective/volto-image-editor/issues)
- Discussions: [Plone Community Forum](https://community.plone.org)

---

## Next Steps

Explore individual components for details:

- **ImageEditor**: Complete editor
- **Navigation**: Toolbar
- **SettingsModal**: Advanced settings
- **Slider**: Adjustment control
- **AdjustableImage**: Renderer with filters
- **Button**: Base component
